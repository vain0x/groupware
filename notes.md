# メモ

## 目的

- 常時接続のシステムを試す
- イベントソーシングを試す
- クライアント側のデータ管理の導出を目指す

### 目標

- 更新異常をなくすこと
- 問題の診断がやりやすいこと
- クライアントの性能が高いこと
    (スケールすることは目標としない)

## 機能

- ユーザー登録、ログイン、ログアウト
- 自分のユーザー情報の閲覧と変更
- カレンダー
    - 全ユーザーのスケジュールを時系列順に表示
    - スケジュールの登録と変更
- イベントログの閲覧ページ
- ユーザーの一覧ページ (管理者のみ)
    - 他のユーザーの情報の登録と変更

## その他

- 常時接続
    - クライアントとサーバーの間をウェブソケットで繋ぐ
    - クライアントからのリクエスト (コマンド) をウェブソケットでサーバーに送る
    - サーバー側の変更 (イベントの追加) をクライアントにプッシュで配信し、ページの状態を最新に保つ
- データのリプリケーション
    - サーバーをリーダー、クライアントをフォロワーとしてデータをリプリケーションする
        (接続が切れているときに利用する)
- イベントソーシング
    - データベースに現在の状態を表すスナップショットと、状態の変更を表すイベントの2種類を持つ
    - サーバーはイベントを時系列順に処理してスナップショットを更新する
- クライアント側のデータ管理
    - サイトに最初に訪問したときは、サーバーが普通にそのページの内容や必要なデータをレスポンスで送る。
        その後、クライアントはサーバーと接続する。サーバーはクライアントにスナップショットを配信し、クライアントはそれをローカルストレージか何かに保存する。
    - サイト内のページ遷移時は、クライアントがすでに必要なデータを持っているときはそれを使ってページを描画する。
    - サーバー側の変更を受信したらページの状態を更新する。
    - 入力項目のあるページでは、サーバーから来た変更がユーザーによる入力と衝突する問題が発生する。
        クライアントはスナップショットに由来するページの状態と、ユーザーによる入力を分けて持つ。
        サーバーから来た変更がユーザーによる入力と衝突している場合は、その入力を破棄するか上書きするか選ぶためのUI (マージUI) を出す。
- 変更のキャンセル
    - 変更の取り消し(revert)をイベントの逆操作として導出する

### データ構造

クライアント側のデータ管理を導出するため、データ構造を制限する。

number, string, Option[T], Array[T], Set[K], Map[K, T]

(Kは比較可能なデータ、Tは任意のデータ。)

### クエリ

クライアントがサーバーにどういうデータを要求するかをクエリとして記述する。
クライアント側でのUI描画にはクエリで取ったデータと入力されたデータだけを使う。(更新の衝突の判定を自動化するため)

### コマンド

クライアントからサーバーへのリクエストはコマンドと呼ぶ。
1つのコマンドは複数個のイベントを発生させる。
(イベントと違って、コマンドはメールの送信や別のサーバーへのリクエストなどの副作用を発生させる可能性がある。)

### イベント

データ構造への更新を表す差分データをイベントと呼ぶ。
サーバーがイベントを処理すると、単に差分データがスナップショットにパッチされる。
